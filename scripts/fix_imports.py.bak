#!/usr/bin/env python3
"""
–°–∫—Ä–∏–ø—Ç –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏–º–ø–æ—Ä—Ç–æ–≤ –∏–∑ —Å—Ç–∞—Ä–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã sisu_bot –≤ –Ω–æ–≤—É—é app/
–£–ª—É—á—à–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è —Å –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å—é –∏ —Ç–æ—á–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –∏–º–ø–æ—Ä—Ç–æ–≤
"""
import os
import re
import shutil
import difflib
from pathlib import Path
from typing import Dict, List, Tuple
from importlib.util import find_spec

# –ú–∞–ø–ø–∏–Ω–≥ —Å—Ç–∞—Ä—ã—Ö –ø—É—Ç–µ–π –∫ –Ω–æ–≤—ã–º (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –¥—É–±–ª–∏–∫–∞—Ç—ã)
IMPORT_MAPPING = {
    # –û—Å–Ω–æ–≤–Ω—ã–µ –º–æ–¥—É–ª–∏
    'sisu_bot.core.config': 'app.shared.config.settings',
    'sisu_bot.bot.config': 'app.shared.config.bot_config',
    
    # Domain —Å–µ—Ä–≤–∏—Å—ã
    'sisu_bot.bot.services.user_service': 'app.domain.services.user',
    'sisu_bot.bot.services.points_service': 'app.domain.services.gamification.points',
    'sisu_bot.bot.services.top_service': 'app.domain.services.gamification.top',
    'sisu_bot.bot.services.games_service': 'app.domain.services.games',
    'sisu_bot.bot.services.motivation_service': 'app.domain.services.motivation',
    'sisu_bot.bot.services.trigger_service': 'app.domain.services.triggers.core',
    'sisu_bot.bot.services.trigger_stats_service': 'app.domain.services.triggers.stats',
    'sisu_bot.bot.services.command_menu_service': 'app.domain.services.command_menu',
    'sisu_bot.bot.services.excuse_service': 'app.domain.services.excuse',
    'sisu_bot.bot.services.state_service': 'app.domain.services.state',
    'sisu_bot.bot.services.mood_service': 'app.domain.services.mood',
    'sisu_bot.bot.services.ton_service': 'app.domain.services.ton',
    'sisu_bot.bot.services.quiz_service': 'app.domain.services.quiz',
    
    # Infrastructure AI —Å–µ—Ä–≤–∏—Å—ã
    'sisu_bot.bot.services.yandexgpt_service': 'app.infrastructure.ai.providers.yandex_gpt',
    'sisu_bot.bot.services.tts_service': 'app.infrastructure.ai.tts',
    'sisu_bot.bot.services.yandex_speechkit_tts': 'app.infrastructure.ai.providers.yandex_speechkit_tts',
    'sisu_bot.bot.services.persona_service': 'app.infrastructure.ai.persona',
    'sisu_bot.bot.services.ai_memory_service': 'app.infrastructure.ai.memory',
    'sisu_bot.bot.services.ai_stats_service': 'app.infrastructure.ai.stats',
    'sisu_bot.bot.services.ai_trigger_service': 'app.infrastructure.ai.trigger',
    
    # Infrastructure —Å–∏—Å—Ç–µ–º–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã
    'sisu_bot.bot.services.adminlog_service': 'app.infrastructure.system.adminlog',
    'sisu_bot.bot.services.allowed_chats_service': 'app.infrastructure.system.allowed_chats',
    
    # Infrastructure –ë–î
    'sisu_bot.bot.db.models': 'app.infrastructure.db.models',
    'sisu_bot.bot.db.init_db': 'app.infrastructure.db.session',
    'sisu_bot.bot.db.database': 'app.infrastructure.db.database',
    
    # Presentation —Ö–µ–Ω–¥–ª–µ—Ä—ã
    'sisu_bot.bot.handlers.checkin_handler': 'app.presentation.bot.handlers.checkin',
    'sisu_bot.bot.handlers.donate_handler': 'app.presentation.bot.handlers.donate',
    'sisu_bot.bot.handlers.media_handler': 'app.presentation.bot.handlers.media',
    'sisu_bot.bot.handlers.message_handler': 'app.presentation.bot.handlers.message',
    'sisu_bot.bot.handlers.ref_handler': 'app.presentation.bot.handlers.ref',
    'sisu_bot.bot.handlers.admin_handler': 'app.presentation.bot.handlers.admin',
    'sisu_bot.bot.handlers.ai_handler': 'app.presentation.bot.handlers.ai',
    'sisu_bot.bot.handlers.common': 'app.presentation.bot.handlers.common',
    'sisu_bot.bot.handlers.help_handler': 'app.presentation.bot.handlers.help',
    'sisu_bot.bot.handlers.market_handler': 'app.presentation.bot.handlers.market',
    'sisu_bot.bot.handlers.myrank_handler': 'app.presentation.bot.handlers.myrank',
    'sisu_bot.bot.handlers.top_handler': 'app.presentation.bot.handlers.top',
    'sisu_bot.bot.handlers.dialog_handler': 'app.presentation.bot.handlers.dialog',
    'sisu_bot.bot.handlers.start_handler': 'app.presentation.bot.handlers.start_handler',
    'sisu_bot.bot.handlers.superadmin_handler': 'app.presentation.bot.handlers.superadmin_handler',
    'sisu_bot.bot.handlers.commands': 'app.presentation.bot.handlers.commands',
    'sisu_bot.bot.handlers.handlers': 'app.presentation.bot.handlers.handlers',
    
    # Presentation middlewares
    'sisu_bot.bot.middlewares.preprocess': 'app.presentation.bot.middlewares.preprocess',
    'sisu_bot.bot.middlewares.antifraud': 'app.presentation.bot.middlewares.antifraud',
    'sisu_bot.bot.middlewares.allowed_chats_middleware': 'app.presentation.bot.middlewares.allowed_chats',
    'sisu_bot.bot.middlewares.user_sync': 'app.presentation.bot.middlewares.user_sync',
    'sisu_bot.bot.middlewares.rate_limit': 'app.presentation.bot.middlewares.rate_limiter',
    
    # Shared —É—Ç–∏–ª–∏—Ç—ã
    'sisu_bot.bot.utils': 'app.shared.utils.bot_utils',
    
    # –û–±—â–∏–µ –∏–º–ø–æ—Ä—Ç—ã —Å–µ—Ä–≤–∏—Å–æ–≤
    'sisu_bot.bot.services': 'app.domain.services',
    'sisu_bot.bot.handlers': 'app.presentation.bot.handlers',
    'sisu_bot.bot.middlewares': 'app.presentation.bot.middlewares',
}

def validate_new_paths() -> List[str]:
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –Ω–æ–≤—ã—Ö –ø—É—Ç–µ–π –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è"""
    warnings = []
    
    # –î–æ–±–∞–≤–ª—è–µ–º –∫–æ—Ä–µ–Ω—å –ø—Ä–æ–µ–∫—Ç–∞ –≤ sys.path –¥–ª—è –ø–æ–∏—Å–∫–∞ –º–æ–¥—É–ª–µ–π
    import sys
    project_root = Path('.').absolute()
    if str(project_root) not in sys.path:
        sys.path.insert(0, str(project_root))
    
    for old_path, new_path in IMPORT_MAPPING.items():
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–ª—å–∫–æ –∫–æ—Ä–Ω–µ–≤–æ–π –º–æ–¥—É–ª—å
        root_module = new_path.split('.')[0]
        if not find_spec(root_module):
            warnings.append(f"‚ö†Ô∏è –ù–æ–≤—ã–π –ø—É—Ç—å {new_path} –Ω–µ –Ω–∞–π–¥–µ–Ω (–∫–æ—Ä–Ω–µ–≤–æ–π –º–æ–¥—É–ª—å: {root_module})")
    return warnings

def fix_imports_in_file(file_path: Path, dry_run: bool = False) -> Tuple[bool, List[str]]:
    """–ò—Å–ø—Ä–∞–≤–ª—è–µ—Ç –∏–º–ø–æ—Ä—Ç—ã –≤ –æ–¥–Ω–æ–º —Ñ–∞–π–ª–µ —Å —É–ª—É—á—à–µ–Ω–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–æ–π"""
    try:
        with open(file_path, 'r', encoding='utf-8') as f:
            content = f.read()
        
        original_content = content
        changes = []
        
        for old_import, new_import in IMPORT_MAPPING.items():
            # 1. –û–±—Ä–∞–±–æ—Ç–∫–∞ 'from x import y'
            pattern = rf'from\s+{re.escape(old_import)}\s+import\s+([^\n]+)'
            replacement = f'from {new_import} import \\1'
            if re.search(pattern, content):
                content, count = re.subn(pattern, replacement, content)
                if count:
                    changes.append(f'{old_import} -> {new_import} (from-import)')
            
            # 2. –û–±—Ä–∞–±–æ—Ç–∫–∞ 'import x.y'
            pattern = rf'import\s+{re.escape(old_import)}(?:\s|,|$)'
            replacement = f'import {new_import}'
            if re.search(pattern, content):
                content, count = re.subn(pattern, replacement, content)
                if count:
                    changes.append(f'{old_import} -> {new_import} (direct import)')
            
            # 3. –û–±—Ä–∞–±–æ—Ç–∫–∞ –º–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω—ã—Ö –∏–º–ø–æ—Ä—Ç–æ–≤ 'from x import (a, b)'
            pattern = rf'from\s+{re.escape(old_import)}\s+import\s*\('
            replacement = f'from {new_import} import ('
            if re.search(pattern, content):
                content, count = re.subn(pattern, replacement, content)
                if count:
                    changes.append(f'{old_import} -> {new_import} (multiline import)')
            
            # 4. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã—Ö –∏–º–ø–æ—Ä—Ç–æ–≤ 'from ..x import y'
            pattern = rf'from\s+\.\.{re.escape(old_import.split(".")[-1])}\s+import'
            replacement = f'from ..{new_import.split(".")[-1]} import'
            if re.search(pattern, content):
                content, count = re.subn(pattern, replacement, content)
                if count:
                    changes.append(f'{old_import} -> {new_import} (relative import)')
            
            # 5. –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–º–ø–æ—Ä—Ç–æ–≤ —Å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º–∏ 'from x import y # comment'
            pattern = rf'from\s+{re.escape(old_import)}\s+import\s+([^\n#]+)(?:#.*)?'
            replacement = f'from {new_import} import \\1'
            if re.search(pattern, content):
                content, count = re.subn(pattern, replacement, content)
                if count:
                    changes.append(f'{old_import} -> {new_import} (commented import)')
            
            # 6. –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–º–ø–æ—Ä—Ç–æ–≤ –∏–∑ –ø–æ–¥–º–æ–¥—É–ª–µ–π 'from x.y import z'
            # –≠—Ç–æ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–ª—è —Å–ª—É—á–∞–µ–≤ —Ç–∏–ø–∞ 'from sisu_bot.bot.services import points_service'
            if old_import == 'sisu_bot.bot.services':
                # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∂–¥—ã–π —Å–µ—Ä–≤–∏—Å –æ—Ç–¥–µ–ª—å–Ω–æ
                service_mappings = {
                    'points_service': 'app.domain.services.gamification.points',
                    'top_service': 'app.domain.services.gamification.top',
                    'user_service': 'app.domain.services.user',
                    'games_service': 'app.domain.services.games',
                    'motivation_service': 'app.domain.services.motivation',
                    'trigger_service': 'app.domain.services.triggers.core',
                    'trigger_stats_service': 'app.domain.services.triggers.stats',
                    'command_menu_service': 'app.domain.services.command_menu',
                    'excuse_service': 'app.domain.services.excuse',
                    'state_service': 'app.domain.services.state',
                    'mood_service': 'app.domain.services.mood',
                    'ton_service': 'app.domain.services.ton',
                    'quiz_service': 'app.domain.services.quiz',
                }
                
                for service_name, new_service_path in service_mappings.items():
                    pattern = rf'from\s+{re.escape(old_import)}\s+import\s+([^,\n]+{service_name}[^,\n]*)'
                    replacement = f'from {new_service_path} import \\1'
                    if re.search(pattern, content):
                        content, count = re.subn(pattern, replacement, content)
                        if count:
                            changes.append(f'{old_import}.{service_name} -> {new_service_path} (service import)')
            
            # 7. –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–º–ø–æ—Ä—Ç–æ–≤ handlers –∏ middlewares
            if old_import == 'sisu_bot.bot.handlers':
                handler_mappings = {
                    'handlers': 'app.presentation.bot.handlers.handlers',
                }
                
                for handler_name, new_handler_path in handler_mappings.items():
                    pattern = rf'from\s+{re.escape(old_import)}\s+import\s+([^,\n]+{handler_name}[^,\n]*)'
                    replacement = f'from {new_handler_path} import \\1'
                    if re.search(pattern, content):
                        content, count = re.subn(pattern, replacement, content)
                        if count:
                            changes.append(f'{old_import}.{handler_name} -> {new_handler_path} (handler import)')
            
            if old_import == 'sisu_bot.bot.middlewares':
                middleware_mappings = {
                    'LoggingMiddleware': 'app.presentation.bot.middlewares.logging',
                    'AdminMiddleware': 'app.presentation.bot.middlewares.admin',
                    'AntiFloodMiddleware': 'app.presentation.bot.middlewares.antifraud',
                    'ChatMiddleware': 'app.presentation.bot.middlewares.allowed_chats',
                    'LearningMiddleware': 'app.presentation.bot.middlewares.learning',
                }
                
                for middleware_name, new_middleware_path in middleware_mappings.items():
                    pattern = rf'from\s+{re.escape(old_import)}\s+import\s+([^,\n]+{middleware_name}[^,\n]*)'
                    replacement = f'from {new_middleware_path} import \\1'
                    if re.search(pattern, content):
                        content, count = re.subn(pattern, replacement, content)
                        if count:
                            changes.append(f'{old_import}.{middleware_name} -> {new_middleware_path} (middleware import)')
        
        if content != original_content:
            if not dry_run:
                # –°–æ–∑–¥–∞–µ–º backup –ø–µ—Ä–µ–¥ –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º
                backup_path = file_path.with_suffix('.py.bak')
                if not backup_path.exists():
                    shutil.copy2(file_path, backup_path)
                
                with open(file_path, 'w', encoding='utf-8') as f:
                    f.write(content)
            return True, changes
        
        return False, []
        
    except Exception as e:
        print(f"üö® –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ {file_path}: {str(e)}")
        return False, []

def dry_run_analysis(file_path: Path) -> None:
    """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –±–µ–∑ –∑–∞–ø–∏—Å–∏ —Ñ–∞–π–ª–∞"""
    try:
        with open(file_path, 'r', encoding='utf-8') as f:
            content = f.read()
        
        original_content = content
        
        for old_import, new_import in IMPORT_MAPPING.items():
            # –ü—Ä–∏–º–µ–Ω—è–µ–º —Ç–µ –∂–µ –∑–∞–º–µ–Ω—ã —á—Ç–æ –∏ –≤ fix_imports_in_file
            pattern = rf'from\s+{re.escape(old_import)}\s+import\s+([^\n]+)'
            replacement = f'from {new_import} import \\1'
            content = re.sub(pattern, replacement, content)
            
            pattern = rf'import\s+{re.escape(old_import)}(?:\s|,|$)'
            replacement = f'import {new_import}'
            content = re.sub(pattern, replacement, content)
            
            pattern = rf'from\s+{re.escape(old_import)}\s+import\s*\('
            replacement = f'from {new_import} import ('
            content = re.sub(pattern, replacement, content)
        
        if content != original_content:
            print(f"üîç –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ {file_path}:")
            diff = difflib.unified_diff(
                original_content.splitlines(keepends=True),
                content.splitlines(keepends=True),
                fromfile=str(file_path),
                tofile=str(file_path),
                lineterm=''
            )
            for line in diff:
                if line.startswith('+'):
                    print(f"  + {line[1:].rstrip()}")
                elif line.startswith('-'):
                    print(f"  - {line[1:].rstrip()}")
                elif line.startswith('@@'):
                    print(f"  {line.rstrip()}")
    
    except Exception as e:
        print(f"üö® –û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ {file_path}: {str(e)}")

def main():
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è"""
    import argparse
    
    parser = argparse.ArgumentParser(description='–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–º–ø–æ—Ä—Ç–æ–≤ –≤ –ø—Ä–æ–µ–∫—Ç–µ')
    parser.add_argument('--dry-run', action='store_true', help='–ü–æ–∫–∞–∑–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –±–µ–∑ –∑–∞–ø–∏—Å–∏')
    parser.add_argument('--validate', action='store_true', help='–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–æ–≤—ã–µ –ø—É—Ç–∏')
    args = parser.parse_args()
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–æ–≤—ã—Ö –ø—É—Ç–µ–π
    if args.validate:
        warnings = validate_new_paths()
        if warnings:
            print("‚ö†Ô∏è –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è:")
            for warning in warnings:
                print(f"  {warning}")
        else:
            print("‚úÖ –í—Å–µ –Ω–æ–≤—ã–µ –ø—É—Ç–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã")
        return
    
    project_root = Path('.')
    python_files = list(project_root.rglob('*.py'))
    
    # –ò—Å–∫–ª—é—á–∞–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ, git –∏ backup —Ñ–∞–π–ª—ã
    python_files = [f for f in python_files 
                   if '.venv' not in str(f) 
                   and '.git' not in str(f)
                   and not f.name.endswith('.bak')]
    
    print(f"üîç –ù–∞–π–¥–µ–Ω–æ {len(python_files)} Python —Ñ–∞–π–ª–æ–≤")
    
    if args.dry_run:
        print("üîç –†–µ–∂–∏–º –∞–Ω–∞–ª–∏–∑–∞ (–±–µ–∑ –∑–∞–ø–∏—Å–∏):")
        for file_path in python_files:
            dry_run_analysis(file_path)
        return
    
    total_changed = 0
    total_changes = 0
    
    for file_path in python_files:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –≤ —Ñ–∞–π–ª–µ —Å—Ç–∞—Ä—ã–µ –∏–º–ø–æ—Ä—Ç—ã
        with open(file_path, 'r', encoding='utf-8') as f:
            content = f.read()
        
        has_old_imports = any(f'from {old_import}' in content or f'import {old_import}' in content 
                             for old_import in IMPORT_MAPPING.keys())
        
        if has_old_imports:
            print(f"üîç –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é {file_path} (–Ω–∞–π–¥–µ–Ω—ã —Å—Ç–∞—Ä—ã–µ –∏–º–ø–æ—Ä—Ç—ã)")
        
        changed, changes = fix_imports_in_file(file_path, dry_run=False)
        if changed:
            total_changed += 1
            total_changes += len(changes)
            print(f"‚úÖ {file_path}: {len(changes)} –∏–∑–º–µ–Ω–µ–Ω–∏–π")
            for change in changes:
                print(f"   {change}")
        elif has_old_imports:
            print(f"‚ö†Ô∏è {file_path}: —Å—Ç–∞—Ä—ã–µ –∏–º–ø–æ—Ä—Ç—ã –Ω–∞–π–¥–µ–Ω—ã, –Ω–æ –Ω–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã")
    
    print(f"\nüìä –ò—Ç–æ–≥–∏:")
    print(f"   –ò–∑–º–µ–Ω–µ–Ω–æ —Ñ–∞–π–ª–æ–≤: {total_changed}")
    print(f"   –í—Å–µ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏–π: {total_changes}")
    
    if total_changed > 0:
        print(f"\nüíæ –°–æ–∑–¥–∞–Ω—ã backup —Ñ–∞–π–ª—ã (.py.bak) –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤")

if __name__ == '__main__':
    main() 