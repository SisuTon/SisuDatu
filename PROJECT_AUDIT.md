# üîç –ü–û–õ–ù–´–ô –ê–£–î–ò–¢ –ü–†–û–ï–ö–¢–ê SISU DATU BOT

## üìä –ê–†–•–ò–¢–ï–ö–¢–£–†–ê –ü–†–û–ï–ö–¢–ê

### üèóÔ∏è –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:

1. **Telegram Bot (aiogram 3.x)**
   - –û—Å–Ω–æ–≤–Ω–æ–π –¥–≤–∏–∂–æ–∫ –±–æ—Ç–∞
   - –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥, –º–µ–¥–∏–∞, –∏–≥—Ä
   - –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ –±–∞–ª–ª–æ–≤, –ª–∏–º–∏—Ç—ã, –∞–Ω—Ç–∏—Ñ—Ä–æ–¥

2. **Handlers (–û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏)**
   - `ai_handler.py` - AI –¥–∏–∞–ª–æ–≥–∏ –∏ –æ—Ç–≤–µ—Ç—ã
   - `message_handler.py` - –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
   - `checkin_handler.py` - —Å–∏—Å—Ç–µ–º–∞ —á–µ–∫-–∏–Ω–æ–≤
   - `media_handler.py` - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –º–µ–¥–∏–∞
   - `admin_handler.py` - –∞–¥–º–∏–Ω—Å–∫–∏–µ –∫–æ–º–∞–Ω–¥—ã
   - `donate_handler.py` - —Å–∏—Å—Ç–µ–º–∞ –¥–æ–Ω–∞—Ç–æ–≤

3. **Middlewares (–ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏)**
   - `allowed_chats_middleware.py` - –∫–æ–Ω—Ç—Ä–æ–ª—å –¥–æ—Å—Ç—É–ø–∞ –∫ —á–∞—Ç–∞–º
   - `message_logging.py` - –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π
   - `antifraud.py` - –∑–∞—â–∏—Ç–∞ –æ—Ç –º–æ—à–µ–Ω–Ω–∏—á–µ—Å—Ç–≤–∞
   - `rate_limit.py` - –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —á–∞—Å—Ç–æ—Ç—ã –∑–∞–ø—Ä–æ—Å–æ–≤
   - `user_sync.py` - —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

4. **Services (–°–µ—Ä–≤–∏—Å—ã)**
   - `points_service.py` - —Å–∏—Å—Ç–µ–º–∞ –±–∞–ª–ª–æ–≤ –∏ —Ä–∞–Ω–≥–æ–≤
   - `user_service.py` - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
   - `ai_trigger_service.py` - —Ç—Ä–∏–≥–≥–µ—Ä—ã –∏ –æ—Ç–≤–µ—Ç—ã
   - `auto_learning_service.py` - –∞–≤—Ç–æ–æ–±—É—á–µ–Ω–∏–µ
   - `message_service.py` - —Ä–∞–±–æ—Ç–∞ —Å —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
   - `yandexgpt_service.py` - –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å YandexGPT
   - `yandex_speechkit_tts.py` - —Å–∏–Ω—Ç–µ–∑ —Ä–µ—á–∏

5. **Database (–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö)**
   - SQLite –±–∞–∑–∞ —Å —Ç–∞–±–ª–∏—Ü–∞–º–∏: users, messages, donations, etc.
   - Alembic –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–π

6. **Data Files (JSON —Ñ–∞–π–ª—ã)**
   - `ai_fallback_phrases.json` - —Ä–µ–∑–µ—Ä–≤–Ω—ã–µ —Ñ—Ä–∞–∑—ã
   - `sisu_persona.json` - –ø–µ—Ä—Å–æ–Ω–∞–∂ –°–∏—Å—É
   - `learning_data.json` - –¥–∞–Ω–Ω—ã–µ –∞–≤—Ç–æ–æ–±—É—á–µ–Ω–∏—è
   - `ranks.json` - —Å–∏—Å—Ç–µ–º–∞ —Ä–∞–Ω–≥–æ–≤
   - `triggers.json` - —Ä–∞–∑–ª–∏—á–Ω—ã–µ —Ç—Ä–∏–≥–≥–µ—Ä—ã

## üéØ –õ–û–ì–ò–ö–ê –†–ê–ë–û–¢–´ –ë–û–¢–ê

### üìà –°–∏—Å—Ç–µ–º–∞ –±–∞–ª–ª–æ–≤:
1. **–ß–µ–∫-–∏–Ω** - `/checkin` (—Ä–∞–∑ –≤ —Å—É—Ç–∫–∏, —Ç–æ–ª—å–∫–æ –≤ –≥—Ä—É–ø–ø–∞—Ö)
2. **–ú–µ–¥–∏–∞** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ –∑–∞ —Ñ–æ—Ç–æ/–≤–∏–¥–µ–æ
3. **–†–∞–Ω–≥–∏** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ–≤—ã—à–µ–Ω–∏–µ –ø–æ –±–∞–ª–ª–∞–º
4. **–†–µ—Ñ–µ—Ä–∞–ª—ã** - –±–æ–Ω—É—Å—ã –∑–∞ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è

### ü§ñ AI –î–∏–∞–ª–æ–≥–∏:
1. **YandexGPT** - –æ—Å–Ω–æ–≤–Ω–æ–π AI –¥–≤–∏–∂–æ–∫
2. **–¢—Ä–∏–≥–≥–µ—Ä—ã** - –ø—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã
3. **Fallback** - —Ä–µ–∑–µ—Ä–≤–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
4. **–ê–≤—Ç–æ–æ–±—É—á–µ–Ω–∏–µ** - –∏–∑—É—á–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö —Ñ—Ä–∞–∑

### üõ°Ô∏è –ó–∞—â–∏—Ç–∞ –∏ –ª–∏–º–∏—Ç—ã:
1. **Rate Limiting** - –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —á–∞—Å—Ç–æ—Ç—ã –∑–∞–ø—Ä–æ—Å–æ–≤
2. **Anti-fraud** - –∑–∞—â–∏—Ç–∞ –æ—Ç –º–æ—à–µ–Ω–Ω–∏—á–µ—Å—Ç–≤–∞
3. **Allowed Chats** - –∫–æ–Ω—Ç—Ä–æ–ª—å –¥–æ—Å—Ç—É–ø–∞ –∫ —á–∞—Ç–∞–º
4. **AI Limits** - –ª–∏–º–∏—Ç—ã –Ω–∞ AI –∑–∞–ø—Ä–æ—Å—ã

## üîß –°–ò–°–¢–ï–ú–ê FALLBACK (–†–µ–∑–µ—Ä–≤–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã)

### üìù –¢–µ–∫—Å—Ç–æ–≤—ã–µ fallback:
```json
{
  "fallback": [
    "–ü–æ—á–µ–º—É —É –¥—Ä–∞–∫–æ–Ω–∞ –≤—Å–µ–≥–¥–∞ —Ö–æ—Ä–æ—à–µ–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ? –ü–æ—Ç–æ–º—É —á—Ç–æ –æ–Ω –Ω–µ –ø–∞—Ä–∏—Ç—Å—è, –∞ –∂–∞—Ä–∏—Ç!",
    "–°–∏—Å—É –Ω–µ —Ä–∞—Å—Å–∫–∞–∑—ã–≤–∞–µ—Ç –∞–Ω–µ–∫–¥–æ—Ç—ã, –æ–Ω–∞ –∏—Ö –≤—ã–¥—ã—Ö–∞–µ—Ç!",
    "–ë—Ä–∞—Ç, —Ö–æ—á–µ—à—å –º–µ–º? –°–∏—Å—É –æ–¥–Ω–∞–∂–¥—ã –ø–æ–ø—ã—Ç–∞–ª–∞—Å—å —Å–∂–µ—á—å –≤–æ–¥—É... –ü–æ–ª—É—á–∏–ª—Å—è —á–∞–π!",
    // ... 47 —Ñ—Ä–∞–∑
  ]
}
```

### üé§ –ì–æ–ª–æ—Å–æ–≤—ã–µ fallback:
```python
SISU_TTS_FALLBACK_VOICES = [
    "–ù–µ –º–µ—à–∞–π, —è —Å–ø–ª—é!",
    "–Ø –æ—Ç–æ—à–ª–∞, –ø–æ–π–¥—É –ø–æ–π–º–∞—é –≤–∞–π–±!",
    "–î—Ä–∞–∫–æ–Ω—ã —Ç–æ–∂–µ –æ—Ç–¥—ã—Ö–∞—é—Ç, –ø–æ–ø—Ä–æ–±—É–π –ø–æ–∑–∂–µ!",
    "–ò–¥–∏ –º—É–∑—ã–∫—É –ø–æ—Å–ª—É—à–∞–π, –∞ —è —Ç—É—Ç –ø–æ–¥—Ä–µ–º–ª—é!",
    "–°–µ–≥–æ–¥–Ω—è –Ω–µ –º–æ–π –¥–µ–Ω—å –¥–ª—è —Å—Ç–∏—Ö–æ–≤, –ø–æ–ø—Ä–æ–±—É–π –∑–∞–≤—Ç—Ä–∞!",
    "–Ø —É—à–ª–∞ —Ç—É—Å–∏—Ç—å —Å –°–Ω—É–ø –î–æ–≥–≥–æ–º, –≤–µ—Ä–Ω—É—Å—å –ø–æ–∑–∂–µ!"
]
```

### üé≠ –ü–µ—Ä—Å–æ–Ω–∞–∂ –°–∏—Å—É:
```json
{
  "identity": {
    "name": "–°–∏—Å—É",
    "species": "–≤–æ–¥–Ω—ã–π –¥—Ä–∞–∫–æ–Ω",
    "gender": "–¥–µ–≤–æ—á–∫–∞",
    "vibe": "–º–µ–º–Ω–∞—è, –≤–∞–π–±–æ–≤–∞—è, –¥–æ–±—Ä–∞—è, –∏—Ä–æ–Ω–∏—á–Ω–∞—è",
    "loves": ["—Ç–æ–Ω", "Sisu Token", "–≤–æ–¥—É", "–æ–±–ª–∞–∫–∞", "–ø–æ–¥–∞—Ä–∫–∏"],
    "hates": ["—Å–∫–∞–º–µ—Ä–æ–≤", "–≥–∞—Å—Ñ–∏–∏", "—Ç–æ–∫—Å–∏–∫–æ–≤", "FUD", "—Ü–µ–Ω–∑—É—Ä—É"]
  },
  "fallbacks": [
    "–ù–µ –∑–Ω–∞—é, –Ω–æ —á—É–≤—Å—Ç–≤—É—é, —á—Ç–æ –æ—Ç–≤–µ—Ç –≥–¥–µ-—Ç–æ —Å—Ä–µ–¥–∏ –æ–±–ª–∞–∫–æ–≤.",
    "–≠—Ç–æ—Ç –≤–æ–ø—Ä–æ—Å –Ω–µ –¥–ª—è –º–æ–µ–≥–æ —É—Ä–æ–≤–Ω—è –º–∞–≥–∏–∏, –Ω–æ —Ç—ã –∫–ª–∞—Å—Å–Ω—ã–π!",
    "–Ø –±—ã –æ—Ç–≤–µ—Ç–∏–ª–∞, –Ω–æ –≥–æ—Ç–æ–≤–ª—é—Å—å –∫ NFT-–¥–æ–∂–¥—é!"
  ]
}
```

## üö® –ü–†–û–ë–õ–ï–ú–ê –° YANDEXGPT

### ‚ùå –¢–µ–∫—É—â–∞—è –æ—à–∏–±–∫–∞:
```
YandexGPT API HTTP —Å—Ç–∞—Ç—É—Å: 400
"Specified folder ID 'b1g84sva7hgoe07stehp' does not match with service account folder ID 'b1g84sva7hgoe0s7tehp'"
```

### ‚úÖ –†–µ—à–µ–Ω–∏–µ:
–ò—Å–ø—Ä–∞–≤–∏—Ç—å folder ID –≤ `.env` —Ñ–∞–π–ª–µ:
```
YANDEXGPT_FOLDER_ID=b1g84sva7hgoe0s7tehp
```

## üîÑ –õ–û–ì–ò–ö–ê –û–ë–†–ê–ë–û–¢–ö–ò –û–®–ò–ë–û–ö

### 1. **AI Handler Error Handling:**
```python
try:
    response_text = await generate_sisu_reply(prompt=f"{text}{mood_prompt_addition}")
    await msg.answer(response_text)
except Exception as e:
    logger.error(f"Failed to generate AI response: {e}")
    await msg.answer("–ò–∑–≤–∏–Ω–∏—Ç–µ, —É –º–µ–Ω—è –ø—Ä–æ–±–ª–µ–º—ã —Å –æ—Ç–≤–µ—Ç–æ–º üòî")
```

### 2. **Fallback Chain:**
1. **YandexGPT** - –æ—Å–Ω–æ–≤–Ω–æ–π AI
2. **–¢—Ä–∏–≥–≥–µ—Ä—ã** - –ø—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã
3. **Persona Fallbacks** - –æ—Ç–≤–µ—Ç—ã –∏–∑ –ø–µ—Ä—Å–æ–Ω—ã
4. **Generic Fallbacks** - –æ–±—â–∏–µ —Ñ—Ä–∞–∑—ã
5. **Error Message** - "–ò–∑–≤–∏–Ω–∏—Ç–µ, —É –º–µ–Ω—è –ø—Ä–æ–±–ª–µ–º—ã —Å –æ—Ç–≤–µ—Ç–æ–º üòî"

### 3. **Voice Fallback:**
```python
try:
    voice_bytes = await synthesize_sisu_voice(phrase)
    await msg.answer_voice(voice=voice_file)
except Exception:
    await msg.answer("–°–∏—Å—É –¥–∞–∂–µ –≥–æ–ª–æ—Å –Ω–µ —Ö–æ—á–µ—Ç –≤–∫–ª—é—á–∞—Ç—å! –ü–æ–ø—Ä–æ–±—É–π –ø–æ–∑–∂–µ!")
```

## üìä –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨–°–ö–ò–ô –û–ü–´–¢

### ‚úÖ –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:
1. **–ö–æ–º–∞–Ω–¥—ã** - –≤—Å–µ –∫–æ–º–∞–Ω–¥—ã —Ä–∞–±–æ—Ç–∞—é—Ç
2. **Middleware** - –ø—Ä–∞–≤–∏–ª—å–Ω–æ –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
3. **Fallback —Å–∏—Å—Ç–µ–º–∞** - –µ—Å—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã
4. **–ê–≤—Ç–æ–æ–±—É—á–µ–Ω–∏–µ** - —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è

### ‚ùå –ß—Ç–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç:
1. **YandexGPT** - –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π folder ID
2. **AI –æ—Ç–≤–µ—Ç—ã** - –ø–∞–¥–∞—é—Ç –≤ fallback

## üõ†Ô∏è –¢–ï–•–ù–ò–ß–ï–°–ö–ê–Ø –ê–†–•–ò–¢–ï–ö–¢–£–†–ê

### üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤:
```
sisu_bot/
‚îú‚îÄ‚îÄ bot/
‚îÇ   ‚îú‚îÄ‚îÄ handlers/     # –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥
‚îÇ   ‚îú‚îÄ‚îÄ middlewares/  # –ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
‚îÇ   ‚îú‚îÄ‚îÄ services/     # –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞
‚îÇ   ‚îú‚îÄ‚îÄ db/          # –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
‚îÇ   ‚îî‚îÄ‚îÄ config.py    # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îú‚îÄ‚îÄ data/            # JSON —Ñ–∞–π–ª—ã —Å –¥–∞–Ω–Ω—ã–º–∏
‚îú‚îÄ‚îÄ core/            # –Ø–¥—Ä–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
‚îî‚îÄ‚îÄ tests/           # –¢–µ—Å—Ç—ã
```

### üîó –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:
- `aiogram==3.*` - Telegram Bot API
- `yandexcloud==0.227.0` - Yandex Cloud SDK
- `sqlalchemy==2.0.25` - ORM
- `fastapi==0.110.*` - Admin Panel
- `aiohttp==3.9.3` - HTTP –∫–ª–∏–µ–Ω—Ç

## üéØ –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò

### 1. **–ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å:**
- Folder ID –≤ `.env` —Ñ–∞–π–ª–µ

### 2. **–£–ª—É—á—à–∏—Ç—å fallback —Å–∏—Å—Ç–µ–º—É:**
- –î–æ–±–∞–≤–∏—Ç—å –±–æ–ª—å—à–µ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤
- –£–ª—É—á—à–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫
- –î–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã

### 3. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:**
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö AI –æ—à–∏–±–æ–∫
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è fallback
- –ê–ª–µ—Ä—Ç—ã –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö —Å API

## üéâ –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï

**–ü—Ä–æ–µ–∫—Ç –∏–º–µ–µ—Ç –æ—Ç–ª–∏—á–Ω—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É –∏ —Å–∏—Å—Ç–µ–º—É fallback!** 

–ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞ - –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π folder ID –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ YandexGPT. –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±–æ—Ç –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –∫–∞–∫ –ø–µ—Ä—Å–æ–Ω–∞–∂ —Å –ø–æ–ª–Ω—ã–º –Ω–∞–±–æ—Ä–æ–º —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤.

**–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É!** üöÄ
