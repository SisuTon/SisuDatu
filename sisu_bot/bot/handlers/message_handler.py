import json
import random
from aiogram import Router, F
from aiogram.types import Message, ChatMemberUpdated
from aiogram.filters import Command
from pathlib import Path
from bot.services.allowed_chats_service import list_allowed_chats
from bot.services import top_service

router = Router()

SISU_GREETINGS = [
    "üêâ –ü—Ä–∏–≤–µ—Ç, —è ‚Äî –¥—Ä–∞–∫–æ–Ω–∏—Ö–∞ –°–∏—Å—É!\n–Ø —Ç–æ–ª—å–∫–æ —á—Ç–æ –ø—Ä–∏–ª–µ—Ç–µ–ª–∞ –≤ —ç—Ç–æ—Ç —á–∞—Ç, –Ω–æ —á—Ç–æ–±—ã –æ—Å—Ç–∞—Ç—å—Å—è –∑–¥–µ—Å—å –∏ –ø–æ–º–æ–≥–∞—Ç—å –≤–∞–º, –º–æ—ë –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏–µ –¥–æ–ª–∂–µ–Ω –æ–¥–æ–±—Ä–∏—Ç—å –º–æ–π –¥—Ä—É–≥ –∏ —Ö—Ä–∞–Ω–∏—Ç–µ–ª—å ‚Äî –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä @bakeevsergey.\n–ù–∞–ø–∏—à–∏ –µ–º—É, –µ—Å–ª–∏ —Ö–æ—á–µ—à—å, —á—Ç–æ–±—ã —è –æ—Å—Ç–∞–ª–∞—Å—å –∏ –∑–∞–∂–∏–≥–∞–ª–∞ –≤–º–µ—Å—Ç–µ —Å –≤–∞–º–∏! ‚ú®",
    "üåä –û–≥–æ, —Å–∫–æ–ª—å–∫–æ —Ç—É—Ç –ª—é–¥–µ–π! –Ø ‚Äî –°–∏—Å—É, –≤–æ–¥–Ω–∞—è –¥—Ä–∞–∫–æ–Ω–∏—Ö–∞.\n–ù–æ —á—Ç–æ–±—ã —è –º–æ–≥–ª–∞ –æ—Å—Ç–∞—Ç—å—Å—è –∏ —Ç–≤–æ—Ä–∏—Ç—å –º–∞–≥–∏—é, –Ω—É–∂–Ω–æ, —á—Ç–æ–±—ã @bakeevsergey —Ä–∞–∑—Ä–µ—à–∏–ª –º–Ω–µ –±—ã—Ç—å –∑–¥–µ—Å—å.\n–ü–æ–ø—Ä–æ—Å–∏ –µ–≥–æ, –µ—Å–ª–∏ —Ö–æ—á–µ—à—å –≤–∏–¥–µ—Ç—å –º–µ–Ω—è –≤ —á–∞—Ç–µ!",
    "‚ú® –ü—Ä–∏–≤–µ—Ç-–ø—Ä–∏–≤–µ—Ç! –≠—Ç–æ –°–∏—Å—É ‚Äî —Å–∞–º–∞—è –¥–æ–±—Ä–∞—è –¥—Ä–∞–∫–æ–Ω–∏—Ö–∞.\n–Ø –º–æ–≥—É –æ—Å—Ç–∞—Ç—å—Å—è –∑–¥–µ—Å—å —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –º–æ–π —Ö—Ä–∞–Ω–∏—Ç–µ–ª—å @bakeevsergey –¥–∞—Å—Ç –¥–æ–±—Ä–æ.\n–ü–∏—à–∏ –µ–º—É, –µ—Å–ª–∏ —Ö–æ—á–µ—à—å, —á—Ç–æ–±—ã —è –æ—Å—Ç–∞–ª–∞—Å—å!",
    "üê≤ –•—ç–π! –Ø ‚Äî –°–∏—Å—É, –∏ —è –ª—é–±–ª—é –Ω–æ–≤—ã–µ –∑–Ω–∞–∫–æ–º—Å—Ç–≤–∞!\n–ù–æ —á—Ç–æ–±—ã —è –º–æ–≥–ª–∞ –æ—Å—Ç–∞—Ç—å—Å—è –≤ —ç—Ç–æ–º —á–∞—Ç–µ, –Ω—É–∂–Ω–æ –æ–¥–æ–±—Ä–µ–Ω–∏–µ –æ—Ç @bakeevsergey.\n–î–∞–π –∑–Ω–∞—Ç—å –µ–º—É, –µ—Å–ª–∏ —Ö–æ—á–µ—à—å, —á—Ç–æ–±—ã —è –±—ã–ª–∞ —Å –≤–∞–º–∏!",
    "üíß –ü—Ä–∏–≤–µ—Ç! –Ø ‚Äî –¥—Ä–∞–∫–æ–Ω–∏—Ö–∞ –°–∏—Å—É, –∏ —è —É–∂–µ –ø–æ—á—Ç–∏ –¥–æ–º–∞‚Ä¶\n–ù–æ –±–µ–∑ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è @bakeevsergey —è –Ω–µ –º–æ–≥—É –æ—Å—Ç–∞—Ç—å—Å—è.\n–ü–æ–ø—Ä–æ—Å–∏ –µ–≥–æ, –µ—Å–ª–∏ —Ö–æ—á–µ—à—å, —á—Ç–æ–±—ã —è –æ—Å—Ç–∞–ª–∞—Å—å –∏ —Ä–∞–¥–æ–≤–∞–ª–∞ –≤–∞—Å!",
    "üåü –û, –º–µ–Ω—è –ø—Ä–∏–≥–ª–∞—Å–∏–ª–∏! –Ø ‚Äî –°–∏—Å—É, –∏ –º–Ω–µ –æ—á–µ–Ω—å —Ö–æ—á–µ—Ç—Å—è –æ—Å—Ç–∞—Ç—å—Å—è.\n–ù–æ —Ç–æ–ª—å–∫–æ @bakeevsergey –º–æ–∂–µ—Ç –¥–∞—Ç—å –º–Ω–µ –∑–µ–ª—ë–Ω—ã–π —Å–≤–µ—Ç.\n–ü–∏—à–∏ –µ–º—É, –µ—Å–ª–∏ —Ö–æ—á–µ—à—å, —á—Ç–æ–±—ã —è –æ—Å—Ç–∞–ª–∞—Å—å!",
    "üêâ –ü—Ä–∏–≤–µ—Ç–∏–∫–∏! –≠—Ç–æ –°–∏—Å—É ‚Äî –≤–∞—à–∞ –Ω–æ–≤–∞—è –ø–æ–¥—Ä—É–≥–∞-–¥—Ä–∞–∫–æ–Ω–∏—Ö–∞.\n–Ø –º–æ–≥—É –æ—Å—Ç–∞—Ç—å—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ @bakeevsergey —Ä–∞–∑—Ä–µ—à–∏—Ç –º–Ω–µ –±—ã—Ç—å –∑–¥–µ—Å—å.\n–î–∞–π –µ–º—É –∑–Ω–∞—Ç—å, –µ—Å–ª–∏ —Ö–æ—á–µ—à—å, —á—Ç–æ–±—ã —è –æ—Å—Ç–∞–ª–∞—Å—å!",
    "üåà –ü—Ä–∏–≤–µ—Ç, —è ‚Äî –°–∏—Å—É!\n–Ø –æ—á–µ–Ω—å —Ö–æ—á—É –æ—Å—Ç–∞—Ç—å—Å—è –≤ —ç—Ç–æ–º —á–∞—Ç–µ, –Ω–æ —Ç–æ–ª—å–∫–æ @bakeevsergey –º–æ–∂–µ—Ç –º–µ–Ω—è —Ç—É—Ç –æ—Å—Ç–∞–≤–∏—Ç—å.\n–ü–æ–ø—Ä–æ—Å–∏ –µ–≥–æ, –µ—Å–ª–∏ —Ö–æ—á–µ—à—å, —á—Ç–æ–±—ã —è –æ—Å—Ç–∞–ª–∞—Å—å!",
    "‚ú® –ü—Ä–∏–≤–µ—Ç! –Ø ‚Äî –¥—Ä–∞–∫–æ–Ω–∏—Ö–∞ –°–∏—Å—É, –∏ —è —É–∂–µ —á—É–≤—Å—Ç–≤—É—é –º–∞–≥–∏—é —ç—Ç–æ–≥–æ —á–∞—Ç–∞!\n–ù–æ —á—Ç–æ–±—ã –æ—Å—Ç–∞—Ç—å—Å—è, –º–Ω–µ –Ω—É–∂–Ω–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –æ—Ç @bakeevsergey.\n–ü–∏—à–∏ –µ–º—É, –µ—Å–ª–∏ —Ö–æ—á–µ—à—å, —á—Ç–æ–±—ã —è –æ—Å—Ç–∞–ª–∞—Å—å!",
    "üê≤ –ü—Ä–∏–≤–µ—Ç, –¥—Ä—É–∑—å—è! –≠—Ç–æ –°–∏—Å—É ‚Äî —Å–∞–º–∞—è –≤–µ—Å—ë–ª–∞—è –¥—Ä–∞–∫–æ–Ω–∏—Ö–∞.\n–Ø –º–æ–≥—É –æ—Å—Ç–∞—Ç—å—Å—è –∑–¥–µ—Å—å —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –º–æ–π —Ö—Ä–∞–Ω–∏—Ç–µ–ª—å @bakeevsergey —Å–∫–∞–∂–µ—Ç \"–¥–∞\".\n–ü–æ–ø—Ä–æ—Å–∏ –µ–≥–æ, –µ—Å–ª–∏ —Ö–æ—á–µ—à—å, —á—Ç–æ–±—ã —è –æ—Å—Ç–∞–ª–∞—Å—å!",
]

@router.message(Command("start"))
async def cmd_start(message: Message):
    if str(message.chat.id) not in list_allowed_chats() and message.chat.type != "private":
        return
    await message.answer("–ü—Ä–∏–≤–µ—Ç! –Ø –±–æ—Ç –°–∏—Å—É. –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?")

@router.my_chat_member()
async def bot_added_to_chat(event: ChatMemberUpdated):
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –±–æ—Ç —Ç–æ–ª—å–∫–æ —á—Ç–æ —Å—Ç–∞–ª —á–ª–µ–Ω–æ–º —á–∞—Ç–∞ (joined/administrator)
    if event.new_chat_member.status in ("member", "administrator") and event.old_chat_member.status in ("left", "kicked"):
        await event.bot.send_message(
            event.chat.id,
            random.choice(SISU_GREETINGS)
        )

def is_non_command_text(message: Message) -> bool:
    text = getattr(message, 'text', None)
    if not text:
        return False
    import re
    # –ù–µ –∫–æ–º–∞–Ω–¥–∞ –∏ –Ω–µ /cmd@BotName
    return not re.match(r"^/\w+(@\w+)?", text)

@router.message(is_non_command_text)
async def update_user_info_handler(msg: Message):
    # –ù–∞—á–∏—Å–ª—è—Ç—å –±–∞–ª–ª—ã —Ç–æ–ª—å–∫–æ –≤ –≥—Ä—É–ø–ø–∞—Ö
    if msg.chat.type != "private":
        user = msg.from_user
        top_service.sync_user_data(user.id, user.username, user.first_name)
    # –í –ª–∏—á–∫–µ ‚Äî –Ω–µ –Ω–∞—á–∏—Å–ª—è—Ç—å –±–∞–ª–ª—ã, –ø—Ä–æ—Å—Ç–æ –º–æ–ª—á–∞—Ç—å –∏–ª–∏ –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ –∫–æ–º–∞–Ω–¥—ã

# –í—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏–≥–Ω–æ—Ä–∏—Ä—É—é—Ç—Å—è (–±–∞–ª–ª—ã –Ω–µ –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è, –±–æ—Ç –º–æ–ª—á–∏—Ç) 